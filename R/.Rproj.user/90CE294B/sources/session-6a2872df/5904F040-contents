---
title: "GQ_AF_markdown.R"
author: "heloise_calzan"
date: "2025-02-13"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
setwd("E:\\github\\BILL_2025\\R")


# Step 1: Load necessary libraries
library(tidyverse)
library(gridExtra)
library(dplyr)
```

# Analyse préliminaires Genotype quality & Allelic frequency

```{r cars}
# Step 2: Import the data
af_data <- read.table("AF_per_SV.txt", header = FALSE, col.names = c("Frequency", "AF"))
gq_data <- read.table("GQ_per_SNP.txt", header = FALSE, col.names = c("Quality", "GQ"))

# Step 3: Check the structure of the data
glimpse(af_data)
glimpse(gq_data)
summary(af_data)
summary(gq_data)
```



```{r}
# Step 4: Create the histograms
af_plot <- ggplot(af_data, aes(x = AF)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +  # Increased binwidth
  labs(title = "Allele Frequency Distribution per SV", x = "Allele Frequency (AF)", y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))


gq_plot <- ggplot(gq_data, aes(x = GQ)) +
  geom_histogram(binwidth = 1, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Genotype Quality Distribution per SNP", x = "Genotype Quality (GQ)", y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

# Step 5: Arrange the plots side by side
grid.arrange(af_plot, gq_plot, ncol = 2)
```

```{r}
sapply(af_data, FUN = class)
summary(af_data$AF)
length(af_data$AF)#130
length(unique(af_data$AF))#130

af_data$AF_factor <- as.factor(af_data$AF)
ggplot(data = af_data, aes(x = AF_factor, y = Frequency)) +
  geom_bar(stat = "identity", width = 0.5, color="#339966", fill="#66CC99") +
  geom_text(aes(label=Frequency), vjust=-0.5, hjust = 0.5, size=2.2) +
  theme(legend.position = "none")  +
  ggtitle("Allele Frequency Distribution per SV") +
  xlab("Fréquence Allélique") + 
  ylab("Fréquence")+
  xlim("0", "1.1") +
  scale_x_discrete(breaks = levels(af_data$AF_factor)[seq(1, length(levels(af_data$AF_factor)), by = 5)])+
  theme_classic() +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 
 


sapply(gq_data, FUN = class)#integer et numeric
sapply(gq_data, FUN = summary)
sapply(gq_data, FUN = length)
sapply(gq_data, FUN = function(x) length(unique(x)))
length(unique(af_data$AF))
unique(gq_data$Quality)
#Quality : proba que le site n'a pas de variant : qualité de 20 : 1% de chance qu'il n'y pas de variant
#on veut que ce soit le plus haut possible


#gq_data$ <- as.factor(af_data$AF)
gq_data$GQ
gq_data$Quality_factor <- as.factor(gq_data$Quality)
ggplot(data = gq_data, aes(x = Quality_factor, y = GQ)) +
  geom_boxplot() +
  theme_classic()

names(gq_data)[names(gq_data) == "Quality"] <- "Frequency"

ggplot(data = gq_data, aes(x = GQ, y = Frequency)) +
  geom_bar(stat = "identity", width = 0.5, color="#339966", fill="#66CC99") +
  geom_text(aes(label=Frequency), vjust=-0.5, hjust = 0.5, size=2.2) +
  theme(legend.position = "none")  +
  ggtitle("Genotype Quality Distribution per SNP") +
  xlab("Genotype Quality (GQ)") + 
  ylab("Frequency")+
  #xlim("0", "1.1") +
  #scale_x_discrete(breaks = levels(af_data$AF_factor)[seq(1, length(levels(af_data$AF_factor)), by = 5)])+
  theme_classic() 
  #theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 
 



```

```{r}
#Créer des groupes (breaks) pour la qualité du génotype (par exemple, de 1 à 5, 6 à 10, etc.)

gq_data$GenotypeQuality_group <- cut(gq_data$GQ,
                                  breaks = seq(1, 47, by = 1),   # Définir les breaks comme souhaité
                                  labels = c( "1-2",  "2-3",  "3-4",  "4-5",  "5-6",  "6-7",  "7-8",  "8-9",  "9-10", "10-11", "11-12", "12-13", "13-14", "14-15", "15-16", "16-17", "17-18", "18-19", "19-20", "20-21", "21-22", "22-23", "23-24", "24-25", "25-26", "26-27", "27-28", "28-29", "29-30", "30-31", "31-32", "32-33", "33-34", "34-35", "35-36", "36-37", "37-38", "38-39", "39-40", "40-41", "41-42", "42-43", "43-44", "44-45", "45-46", "46-47"), right = FALSE)


#max(gq_data$GQ) # 46.194
#min(gq_data$GQ) # 1.444

ggplot(gq_data, aes(x = GQ)) +
  geom_histogram(binwidth = 1, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Genotype Quality Distribution per SNP", x = "Genotype Quality (GQ)", y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(gq_data, aes(x = GenotypeQuality_group, y = Frequency, fill = GenotypeQuality_group)) +
  geom_col() +  # Utiliser geom_col() car Frequency est déjà une valeur
  labs(title = "Fréquence en fonction de la Qualité du Génotype",
       x = "Qualité du Génotype (GQ, groupée)", y = "Fréquence") +
  theme_minimal() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(gq_data, aes(x = GQ)) +
  geom_histogram(binwidth = 2, fill = "#66CC99", color = "black") +  
  labs(title = "Fréquence en fonction de la Qualité du Génotype",
       x = "Qualité du Génotype (GQ)", y = "Fréquence") +
  theme_minimal()
```

# Analyse des variants (premier tableau envoyé par Teo)

```{r}
variants_P15 <- read.csv("count_P15.csv" , header = TRUE, sep = ",",  na ="NA", stringsAsFactors = FALSE)
variants_P30 <- read.csv("count_P30.csv" , header = FALSE, sep = ",",  na ="NA", stringsAsFactors = FALSE)
variants_P50 <- read.csv("count_P50.csv" , header = FALSE, sep = ",",  na ="NA", stringsAsFactors = FALSE)
variants_P65 <- read.csv("count_P65.csv" , header = FALSE, sep = ",",  na ="NA", stringsAsFactors = FALSE)
variants_P90 <- read.csv("count_90.csv" , header = FALSE, sep = ",",  na ="NA", stringsAsFactors = FALSE)


str(variants_P15)
summary(variants_P15)
sapply(variants_P15, FUN = class)

F_colnames <- function(tableau_variant){
  names(tableau_variant)[1] <- "Generation"
  names(tableau_variant)[2] <- "echantillon"
  names(tableau_variant)[3] <- "nb_variant"
  names(tableau_variant)[4] <- "sv_snp"
  tableau_variant$Generation <- as.factor(tableau_variant$Generation)
  tableau_variant$echantillon <- as.factor(tableau_variant$echantillon)
  tableau_variant$sv_snp <- as.factor(tableau_variant$sv_snp)
  return(tableau_variant)
}


variants_P15 <- F_colnames(tableau_variant = variants_P15)
variants_P15 <- variants_P15[-which(variants_P15$Generation == "*_filtered"), ]
variants_P30 <- F_colnames(tableau_variant = variants_P30)
variants_P50 <- F_colnames(tableau_variant = variants_P50)
variants_P65 <- F_colnames(tableau_variant = variants_P65)
variants_P90 <- F_colnames(tableau_variant = variants_P90)

variants_P <- rbind(variants_P15, variants_P30)
variants_P <- rbind(variants_P, variants_P50)
variants_P <- rbind(variants_P, variants_P65)
variants_P <- rbind(variants_P, variants_P90)

str(variants_P)
summary(variants_P)
sapply(variants_P, FUN = class)
sapply(variants_P, FUN = levels)
```

```{r}
#Variant P c'est un Rbind de tous les tableaux 
ggplot(data = variants_P, aes(x = sv_snp, y = nb_variant, color=sv_snp)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  #geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  geom_jitter(shape=16, position=position_jitter(0.2), alpha = 0.5) +
  scale_color_brewer(palette="Dark2") +
  facet_wrap(~Generation, scales = "free_y") + #, ncol = 5
  labs(x = "mutation SNP et SV", y = "nombre de variants") +
  ggtitle("distribution des boîtes à moustaches des mutation\n de type SNP et SV par Génération") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data = variants_P, aes(x = Generation, y = nb_variant, color=sv_snp)) +
  geom_boxplot(position=position_dodge(1), outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  #geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  geom_dotplot(aes(fill = sv_snp), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.5, dotsize = 0.4, show.legend = FALSE) +
  #geom_jitter(shape=16, position=position_jitter(0.2), alpha = 0.5) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") + 
  labs(x = "Génération", y = "Effectif des mutations (SV et SNP)", color = "SV / SNP") +
  ggtitle("Distribution des boîtes à moustaches des mutations\n de type SV et SNP par Génération") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))
```
```{r}
remove(variants_P15, variants_P30, variants_P50, variants_P65, variants_P90, af_data, af_plot, gq_plot)
remove(F_colnames)
```

#Données brutes mutations SV et SNP

```{r}
table_snp <- read.csv("snp.csv" , header = TRUE, sep = ",",  na ="NA", stringsAsFactors = FALSE)
table_sv <- read.csv("sv.csv" , header = TRUE, sep = ",",  na ="NA", stringsAsFactors = FALSE)

names(table_snp)
names(table_snp)[names(table_snp) == "ECHANTILLONQUALITE"] <- "ECHANTILLON"
names(table_snp)[names(table_snp) == "X"] <- "QUALITE"

#table SV
str(table_sv)
sapply(table_sv, FUN = class)
table_sv$ORF <- as.factor(table_sv$ORF)
table_sv$GENERATION <- as.factor(table_sv$GENERATION)
table_sv$TYPE.DE.FICHIER <- as.factor(table_sv$TYPE.DE.FICHIER)
table_sv$TYPE.DE.MUTATION <- as.factor(table_sv$TYPE.DE.MUTATION)

summary(table_sv)
sapply(table_sv, FUN = levels)

table_sv[which(table_sv$ORF == "."),]


table_sv[which(table_sv$GENERATION == "P15"),]$ECHANTILLON %>% unique #10  3  4  5  6  7  8  9
table_sv[which(table_sv$GENERATION == "P30"),]$ECHANTILLON %>% unique #10  1  2  3  4  5  6  7  8  9
table_sv[which(table_sv$GENERATION == "P50"),]$ECHANTILLON %>% unique #10  1  2  3  4  5  6  7  8  9
table_sv[which(table_sv$GENERATION == "P65"),]$ECHANTILLON %>% unique # 1 2 3 7
table_sv[which(table_sv$GENERATION == "P90"),]$ECHANTILLON %>% unique #10  1  2  3  4  5  6  7  8  9

summary(table_sv$FREQUENCE.ALL)
```

## Les SV
compter le nb d'insertion et le nombre de deletion par échantillon et génération
on peut faire le % d'insertion aussi
faire leur longueur moyenne, medianne avec les max, les min les sq
rajouter traitement chaud, traitement froid et pas de traitement

```{r}
#rajouter traitement chaud, traitement froid et pas de traitement
table_sv <- table_sv %>% 
  mutate(traitement_type = case_when(GENERATION == "P15"~"non_traite", 
                                     (GENERATION != "P15" & ECHANTILLON <=5) ~ "traitement_froid",
                                     (GENERATION != "P15" & ECHANTILLON > 5) ~ "traitement_chaud"))
table_sv %>% names()

df_mut_sv <- table_sv %>% 
  group_by(GENERATION, ECHANTILLON, TYPE.DE.MUTATION) %>%
  count()
  #pivot_wider(names_from = TYPE.DE.MUTATION)


names(df_mut_sv)[names(df_mut_sv) == "n"] <- "effectif_type_mutation"

df_mut_sv <- left_join(df_mut_sv, unique(table_sv[,c("GENERATION", "ECHANTILLON", "traitement_type")]), by = c("ECHANTILLON", "GENERATION")) 



df_mut_sv2 <- df_mut_sv %>% aggregate(effectif_type_mutation ~ GENERATION + ECHANTILLON, FUN = sum)
names(df_mut_sv2)[names(df_mut_sv2) == "effectif_type_mutation"] <- "effectif_mutation"
df_mut_sv <- left_join(df_mut_sv, df_mut_sv2, by = c("GENERATION", "ECHANTILLON"))
remove(df_mut_sv2)
df_mut_sv <- df_mut_sv %>% mutate(freq_mutation_type = effectif_type_mutation/effectif_mutation)
df_mut_sv$freq_mutation_type <- round(df_mut_sv$freq_mutation_type, 3)

#frequence allélique par type de mutation
table_sv %>% names()
df <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = mean)
df1 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = median)
df2 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = sd)
df3 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = max)
df4 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = min)

names(df)[names(df) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_mean"
names(df1)[names(df1) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_median"
names(df2)[names(df2) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_sd"
names(df3)[names(df3) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_max"
names(df4)[names(df4) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_min"

df <- left_join(df, df1, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df2, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df3, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df4, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df_mut_sv <- left_join(df_mut_sv, df, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))

remove(df, df1, df2, df3, df4)
#longueur du type de mutation par generation et échantillon
table_sv %>% names()
df <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = mean)
df1 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = median)
df2 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = sd)
df3 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = max)
df4 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = min)

names(df)[names(df) == "LONGUEUR"] <- "LONGUEUR_mean"
names(df1)[names(df1) == "LONGUEUR"] <- "LONGUEUR_median"
names(df2)[names(df2) == "LONGUEUR"] <- "LONGUEUR_sd"
names(df3)[names(df3) == "LONGUEUR"] <- "LONGUEUR_max"
names(df4)[names(df4) == "LONGUEUR"] <- "LONGUEUR_min"

df <- left_join(df, df1, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df2, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df3, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df4, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df_mut_sv <- left_join(df_mut_sv, df, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
remove(df, df1, df2, df3, df4)

#nb de positions différentes concernées par generation par echantillon
table_sv$POSITION_factor <- as.factor(table_sv$POSITION)
nb_positions_gen_ech <- table_sv %>% aggregate(POSITION_factor ~ GENERATION + ECHANTILLON, FUN = function(x) length(unique(x)))
names(nb_positions_gen_ech)[names(nb_positions_gen_ech) == "POSITION_factor"] <- "nb_pos_gen_ech"
df_mut_sv <- left_join(df_mut_sv, nb_positions_gen_ech, by = c("GENERATION", "ECHANTILLON")) 
remove(nb_positions_gen_ech)

#nb de positions différentes concernées par generation par echantillon par type de mutation
nb_positions_gen_ech_type_mut <- table_sv %>% aggregate(POSITION_factor ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = function(x) length(unique(x)))
names(nb_positions_gen_ech_type_mut)[names(nb_positions_gen_ech_type_mut) == "POSITION_factor"] <- "nb_pos_gen_ech_type_mut"
df_mut_sv <- left_join(df_mut_sv, nb_positions_gen_ech_type_mut, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION")) 
remove(nb_positions_gen_ech_type_mut)

df_mut_sv %>% names()
df_mut_sv <- df_mut_sv %>% relocate(traitement_type, .after = ECHANTILLON)
```

```{r}
df_mut_sv %>% names()
ggplot(data = df_mut_sv, aes(x = TYPE.DE.MUTATION, y = effectif_type_mutation, color=TYPE.DE.MUTATION)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  #geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  geom_jitter(shape=16, position=position_jitterdodge(0.2), alpha = 0.5) +
  scale_color_brewer(palette="Dark2") +
  labs(x = "Type de mutation des VS\n (délétion ou insertion)", y = "Effectif des mutations", color = "DEL = délétion /\n INS = insértion") +
  facet_wrap(~GENERATION, scales = "free_y") + #, ncol = 5
  ggtitle("Distribution des boîtes à moustaches des délétions et\n des insértions de variants structuraux (VS) par génération") +
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))

#Même graphe qu'au dessus mais avec geom_dotplot au lien de geom_jitter
ggplot(data = df_mut_sv, aes(x = TYPE.DE.MUTATION, y = effectif_type_mutation, color=TYPE.DE.MUTATION)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center',position=position_dodge(), dotsize=1, alpha = 0.5, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  labs(x = "Type de mutation des VS\n (délétion ou insertion)", y = "Effectif des mutations", color = "DEL = délétion /\n INS = insértion") +
  facet_wrap(~GENERATION, scales = "free_y") + #, ncol = 5
  ggtitle("Distribution des boîtes à moustaches des délétions et\n des insértions de variants structuraux (VS) par génération") +
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data = df_mut_sv, aes(x = GENERATION, y = effectif_type_mutation, color=TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1), outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  #geom_jitter(shape=16, position=position_jitter(), alpha = 0.5) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") + 
  labs(x = "Génération", y = "Effectif des types de mutations (délétions ou insertions)", color = "DEL = délétion /\n INS = insértion") +
  ggtitle("Distribution des boîtes à moustaches des délétions et\n des insértions de variants structuraux  par génération") +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```


(j'essaye de trouver la meilleure manière de représenter visuellement la distribution statistique des insertions et des délétions)

```{r}

ggplot(data = df_mut_sv, aes(x = GENERATION, y = effectif_type_mutation, color=traitement_type, by = traitement_type)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.9 , notch=FALSE,width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.9, dotsize = 0.6, show.legend = TRUE) +
  #geom_jitter(aes(fill = traitement_type, shape = TYPE.DE.MUTATION) , position=position_jitterdodge(), alpha = 0.9) +
  #geom_point(aes(fill = TYPE.DE.MUTATION, shape = TYPE.DE.MUTATION), position=position_jitterdodge(dodge.width=0.5), alpha = 0.5) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_manual(values = c("#990099", "#CC9900")) + 
  labs(x = "Génération", y = "Effectif des types de mutations (délétions ou insertions)", color = "Type de traitement") +
  ggtitle("Distribution des boîtes à moustaches des délétions et\n des insértions de variants structuraux  par type de traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data = df_mut_sv, aes(x = GENERATION, y = effectif_type_mutation, color=traitement_type)) +
  geom_boxplot(position=position_dodge(1), outlier.colour="black", outlier.shape=16,
             outlier.size=2, outlier.alpha = 0.5 ,notch=FALSE) +
  #geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.5, dotsize = 0.5, show.legend = TRUE) +
  geom_jitter(aes(fill = traitement_type, shape = TYPE.DE.MUTATION), position=position_jitterdodge(), alpha = 0.9) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") + 
  labs(x = "Génération", y = "Effectif des types de mutations\n(délétions ou insertions)", color = "Type de traitement") +
  ggtitle("Distribution des boîtes à moustaches des délétions et des\ninsértions de variants structuraux  par type de traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))


#C'est la même chose qu'au dessus mais dans des boites pour les générations
ggplot(data = df_mut_sv, aes(x = traitement_type, y = effectif_type_mutation, color=traitement_type, by = traitement_type)) +
  geom_boxplot(position=position_dodge(1), outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 , notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.8, dotsize = 1) +
  #geom_jitter(aes(fill = traitement_type, shape = TYPE.DE.MUTATION) , position=position_jitterdodge(), alpha = 0.8) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_manual(values = c("#990099", "#CC9900")) + 
  facet_wrap(~GENERATION, scales = "free_y") +
  labs(x = "Type de traitement", y = "Effectif des types de mutations\n(délétions ou insertions)", color = "Type de traitement") +
  ggtitle("Distribution des boîtes à moustaches des délétions et des\ninsértions de variants structuraux  par type de traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 

ggplot(data = df_mut_sv, aes(x = traitement_type, y = effectif_type_mutation, color=traitement_type, by = traitement_type)) +
  geom_boxplot(position=position_dodge(1), outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 , notch=FALSE, width = 0.5) +
  #geom_dotplot(aes(fill = TYPE.DE.MUTATION, shape = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.5, dotsize = 0.3) +
  geom_jitter(aes(fill = traitement_type, shape = TYPE.DE.MUTATION) , position=position_jitterdodge(), alpha = 0.8) +
  scale_color_brewer(palette="Dark2") +
  facet_wrap(~GENERATION, scales = "free_y") +
  labs(x = "Type de traitement", y = "Effectif des types de mutations\n(délétions ou insertions)", color = "Type de traitement") +
  ggtitle("Distribution des boîtes à moustaches des délétions et des\ninsértions de variants structuraux  par type de traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 

##################################
plot_P90 <- df_mut_sv[which(df_mut_sv$GENERATION == "P90"), ] %>%
  ggplot( aes(x = traitement_type, y = effectif_type_mutation,  color=TYPE.DE.MUTATION,  by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 ,  notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  labs(x = "type de traitement") +
  ggtitle("P90") +
  theme_bw() + 
  theme(axis.title.y = element_blank(), legend.position = "none")

plot_P65 <- df_mut_sv[which(df_mut_sv$GENERATION == "P65"), ] %>%
  ggplot( aes(x = traitement_type, y = effectif_type_mutation,  color=TYPE.DE.MUTATION,  by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 ,  notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  labs(x = "type de traitement", color = "Type de mutation\n(INS = insertion, DEL = délétion)") +
  ggtitle("P65") +
  theme_bw() +
  theme(axis.title.y = element_blank())

plot_P50 <- df_mut_sv[which(df_mut_sv$GENERATION == "P50"), ] %>%
  ggplot( aes(x = traitement_type, y = effectif_type_mutation,  color=TYPE.DE.MUTATION,  by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 ,  notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  labs( y = "effectif des type de mutations") +
  ggtitle("P50") +
  theme_bw() + 
  theme(axis.title.x = element_blank(), legend.position = "none")

plot_P30 <- df_mut_sv[which(df_mut_sv$GENERATION == "P30"), ] %>%
  ggplot( aes(x = traitement_type, y = effectif_type_mutation,  color=TYPE.DE.MUTATION,  by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 ,  notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  ggtitle("P30") +
  theme_bw() + 
  theme(legend.position = "none", axis.title =  element_blank() )


plot_P15 <-df_mut_sv[which(df_mut_sv$GENERATION == "P15"), ] %>%
  ggplot( aes(x = traitement_type, y = effectif_type_mutation,  color=TYPE.DE.MUTATION,  by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1),  outlier.colour="black", outlier.shape=16, outlier.size=2, outlier.alpha = 0.5 ,  notch=FALSE, width = 0.5) +
  geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7, show.legend = FALSE) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  ggtitle("P15") +
  theme_bw() + 
  theme(axis.title = element_blank(), legend.position = "none")

plot_P15 
plot_P30
plot_P50
plot_P65
plot_P90
```


```{r, fig.height=10, fig.width=12}
library(patchwork)
plot_P <- plot_P15 + plot_P30 + plot_P50 + plot_P65 + plot_P90 + plot_annotation(title = "Distribution des statistiques des insertions et des délétions\ndes variants structuraux en fonction des traitements et par Génération") + plot_layout(widths = c(2, 3)) 
plot_P

ggsave(plot_P, "boxplot_ins_del_vs_traitement_generation.pdf", width = 12, height = 10)
```





```{r}
#Effectif des mutations délétions et insertions confondues en fonction des traitement et des générations
df_mut_sv[,c("GENERATION", "traitement_type", "ECHANTILLON", "effectif_mutation")] %>% unique() %>%
  ggplot( aes(x = GENERATION, 
                        y = effectif_mutation, 
                        color=traitement_type, 
                        by = traitement_type)) +
  geom_boxplot(position=position_dodge(1), 
               outlier.colour="black", 
               outlier.shape=16,
               outlier.size=2, 
               outlier.alpha = 0.5 ,
               notch=FALSE,
               width = 0.5) +
  #geom_jitter(aes(fill = traitement_type) , position=position_jitterdodge(), alpha = 0.9) +
  geom_dotplot(aes(fill = traitement_type), binaxis='y', stackdir='center', position=position_dodge(), alpha = 0.9, dotsize = 0.7) +
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  labs(x = "Génération", y = "Effectif des mutations", color = "Type de traitement") +
   ggtitle("Distribution des boîtes à moustaches des mutations de variants structuraux\n(délétions et des insértions confondues)   par type de traitement et par génération") +
  theme_bw()
  theme(plot.title = element_text(hjust = 0.5))

#Effectif des mutations délétions et insertions confondues en fonction des traitement et des générations
#df_mut_sv[,c("GENERATION", "traitement_type", "ECHANTILLON", "effectif_mutation")] %>% unique() %>%
#  ggplot( aes(x = GENERATION, 
#                        y = effectif_mutation, 
#                        color=traitement_type, 
#                        by = traitement_type)) +
#  geom_boxplot(position=position_dodge(1), 
#               outlier.colour="black", 
#               outlier.shape=16,
#               outlier.size=2, 
#               outlier.alpha = 0.5 ,
#               notch=FALSE,
#               width = 0.5) +
#  geom_jitter(aes(fill = traitement_type) , position=position_jitterdodge(), alpha = 0.9) +
#  scale_color_brewer(palette="Dark2") +
#  scale_fill_brewer(palette="Dark2") +
#  labs(x = "Génération", y = "Effectif des mutations", color = "Type de traitement") +
#   ggtitle("Distribution des boîtes à moustaches des mutations de variants structuraux\n(délétions et des insértions confondues)   par type de traitement et par génération") +
#  theme_bw()
#  theme(plot.title = element_text(hjust = 0.5))
  
#le rendu est meilleur avec dotplot plutôt qu'avec geom_jitter
  
df_mut_sv[,c("GENERATION", "traitement_type", "ECHANTILLON", "effectif_mutation")] %>% unique() %>%
  ggplot(aes(x = GENERATION,
           y = effectif_mutation,
           by = traitement_type,
           fill = traitement_type)) +
  geom_bar(position=position_dodge(), width=0.5, stat = "identity")+
  scale_fill_brewer(palette="Dark2") +
  labs(x = "Génération", y = "Effectif des mutations", fill = "Type de traitement") +
   ggtitle("Distribution des mutations de variants structuraux\n(délétions et des insértions confondues)   par type de traitement et par génération") +
  theme_bw()
```


```{r}
table_sv[,c("GENERATION", "traitement_type", "TYPE.DE.MUTATION")] %>%
  ggplot(aes(x = traitement_type,
           by = TYPE.DE.MUTATION,
           fill = TYPE.DE.MUTATION)) +
  geom_bar(position=position_dodge(), width=0.5, stat = "count")+
  scale_fill_brewer(palette="Dark2") +
  facet_wrap(~GENERATION, scale = "free") +
  labs(x = "Effectif des mutations", y = "traitement", fill = "Type de mutation\n(DEL = délétion\nINS = insertion)") +
  ggtitle("Distribution des types mutations (délétion et insertion)\nde variants structuraux par traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 

#Ce deuxième graphe ne marche pas trop, je voulais représenter la proportion des types de mutations... mais ça me donne la proportion des types de mutations dans les échantillons...
ggplot(df_mut_sv, aes(x = traitement_type, y = freq_mutation_type, by = TYPE.DE.MUTATION, fill = TYPE.DE.MUTATION)) +
  geom_bar(stat = "identity", position = "fill", width= 0.8, color = "black") +
  facet_wrap(~GENERATION, scale = "free") +
  #geom_text(aes(label = pourcent_eff), stat = "identity",  position = position_fill(.5), size = 2.5, color = "black") +  #facultatif sinon on ne voit rien
  scale_fill_brewer(palette="Dark2") +
  geom_text(aes(label = freq_mutation_type), stat = "identity",  position = position_fill(.5), size = 2, color = "black") +  
    theme_bw()
```




```{r}
#Là j'ai voulu représenter les statistiques de changement de fréquences de mutations en fonction des generation, des traitement et de si c'est des délétions ou des insertion mais c'est nul

#df_mut_sv[,c("GENERATION", "traitement_type", "ECHANTILLON", "effectif_mutation")] %>% unique() %>%
  ggplot(df_mut_sv, aes(x = traitement_type, 
                        y = freq_mutation_type, 
                        color=TYPE.DE.MUTATION, 
                        by = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1), 
               outlier.colour="black", 
               outlier.shape=16,
               outlier.size=2, 
               outlier.alpha = 0.5 ,
               notch=FALSE,
               width = 0.5) +
  geom_jitter(aes(fill = traitement_type) , position=position_jitterdodge(), alpha = 0.9) +
  facet_wrap(~GENERATION, scale = "free") +  
  scale_color_brewer(palette="Dark2") +
  labs(x = "Génération", y = "mutations") +
  theme_bw()
```




Regarder la longueur des mutations en fonction de si c'est del ou ins et en fonction du traitement et des génération
```{r}
table_sv[which(table_sv$GENERATION == "P15"),c("traitement_type", "TYPE.DE.MUTATION", "LONGUEUR")] %>%
  ggplot(aes(x = traitement_type,
             y = abs(LONGUEUR),
           by = TYPE.DE.MUTATION,
           fill = TYPE.DE.MUTATION)) +
  geom_boxplot(position=position_dodge(1)) + 
  #geom_dotplot(aes(fill = TYPE.DE.MUTATION), binaxis='y', stackdir='center', position=position_dodge(1), alpha = 0.8, dotsize = 0.7) + #show.legend = FALSE
  scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2") +
  scale_y_log10() +
  #scale_y_continuous(expand = expansion(mult = c(0.05, 0.05))) +
  ggtitle("P15") +
  theme_bw() #+ 
  #theme(axis.title = element_blank(), legend.position = "none")


```




```{r}
table_sv %>% names()


table_sv <- table_sv %>% mutate(LONGUEUR_abs = round(abs(LONGUEUR),3))
df_length_mut_sv <- table_sv %>% aggregate(LONGUEUR_abs ~ GENERATION + TYPE.DE.MUTATION + traitement_type, FUN = mean)
df2 <- table_sv %>% aggregate(LONGUEUR_abs ~ GENERATION + TYPE.DE.MUTATION + traitement_type, FUN = median)
df3 <- table_sv %>% aggregate(LONGUEUR_abs ~ GENERATION + TYPE.DE.MUTATION + traitement_type, FUN = sd)

names(df_length_mut_sv)[names(df_length_mut_sv) == "LONGUEUR_abs"] <- "LONGUEUR_abs_mean"
names(df2)[names(df2) == "LONGUEUR_abs"] <- "LONGUEUR_abs_median"
names(df3)[names(df3) == "LONGUEUR_abs"] <- "LONGUEUR_abs_sd"

df_length_mut_sv <- left_join(df_length_mut_sv, df2)
df_length_mut_sv <- left_join(df_length_mut_sv, df3)  
remove(df2, df3)


df_length_mut_sv <- df_length_mut_sv %>% mutate(LONGUEUR_abs_mean = round(LONGUEUR_abs_mean,3))
df_length_mut_sv <- df_length_mut_sv %>% mutate(LONGUEUR_abs_sd = round(LONGUEUR_abs_sd,3))

#df_length_mut_sv <- df_length_mut_sv %>% mutate(LONGUEUR_abs = round(abs(LONGUEUR),3))
df_length_mut_sv[which(df_length_mut_sv$GENERATION == "P15"),] %>%
ggplot( aes(x = TYPE.DE.MUTATION, y = LONGUEUR_abs_mean, fill = TYPE.DE.MUTATION)) +
  geom_bar(position = position_dodge(), width=0.5, stat = "identity") +
  geom_text(aes(label = LONGUEUR_abs_mean), stat = "identity", vjust = -1 , size = 2, color = "black")+
  scale_fill_brewer(palette="Dark2") +
  geom_errorbar(aes(ymin= LONGUEUR_abs_mean - LONGUEUR_abs_sd, ymax=LONGUEUR_abs_mean + LONGUEUR_abs_sd), width=.2, position = position_dodge()) +
  scale_y_log10() +
  ggtitle("P15") +
  theme_bw()

df_length_mut_sv[which(df_length_mut_sv$GENERATION == "P30"),] %>%
ggplot( aes(x = TYPE.DE.MUTATION, y = LONGUEUR_abs_mean, fill = TYPE.DE.MUTATION)) +
  geom_bar(position = position_dodge(), width=0.5, stat = "identity") +
  geom_text(aes(label = LONGUEUR_abs_mean), stat = "identity", vjust = -1 , size = 2, color = "black")+
  scale_fill_brewer(palette="Dark2") +
  geom_errorbar(aes(ymin= LONGUEUR_abs_mean - LONGUEUR_abs_sd, ymax=LONGUEUR_abs_mean + LONGUEUR_abs_sd), width=.2, position = position_dodge()) +
  scale_y_log10() +
  facet_wrap(~traitement_type, scale = "free") +
  ggtitle("P30") +
  theme_bw() 

df_length_mut_sv[which(df_length_mut_sv$GENERATION == "P50"),] %>%
ggplot( aes(x = TYPE.DE.MUTATION, y = LONGUEUR_abs_mean, fill = TYPE.DE.MUTATION)) +
  geom_bar(position = position_dodge(), width=0.5, stat = "identity") +
  geom_text(aes(label = LONGUEUR_abs_mean), stat = "identity", vjust = -1 , size = 2, color = "black")+
  scale_fill_brewer(palette="Dark2") +
  geom_errorbar(aes(ymin= LONGUEUR_abs_mean - LONGUEUR_abs_sd, ymax=LONGUEUR_abs_mean + LONGUEUR_abs_sd), width=.2, position = position_dodge()) +
  scale_y_log10() +
  facet_wrap(~traitement_type, scale = "free") +
  ggtitle("P50") +
  theme_bw() 

df_length_mut_sv[which(df_length_mut_sv$GENERATION == "P65"),] %>%
ggplot( aes(x = TYPE.DE.MUTATION, y = LONGUEUR_abs_mean, fill = TYPE.DE.MUTATION)) +
  geom_bar(position = position_dodge(), width=0.5, stat = "identity") +
  geom_text(aes(label = LONGUEUR_abs_mean), stat = "identity", vjust = -1 , size = 2, color = "black")+
  scale_fill_brewer(palette="Dark2") +
  geom_errorbar(aes(ymin= LONGUEUR_abs_mean - LONGUEUR_abs_sd, ymax=LONGUEUR_abs_mean + LONGUEUR_abs_sd), width=.2, position = position_dodge()) +
  scale_y_log10() +
  facet_wrap(~traitement_type, scale = "free") +
  ggtitle("P65") +
  theme_bw() 

df_length_mut_sv[which(df_length_mut_sv$GENERATION == "P90"),] %>%
ggplot( aes(x = TYPE.DE.MUTATION, y = LONGUEUR_abs_mean, fill = TYPE.DE.MUTATION)) +
  geom_bar(position = position_dodge(), width=0.5, stat = "identity") +
  geom_text(aes(label = LONGUEUR_abs_mean), stat = "identity", vjust = -1 , size = 2, color = "black")+
  scale_fill_brewer(palette="Dark2") +
  geom_errorbar(aes(ymin= LONGUEUR_abs_mean - LONGUEUR_abs_sd, ymax=LONGUEUR_abs_mean + LONGUEUR_abs_sd), width=.2, position = position_dodge()) +
  scale_y_log10() +
  facet_wrap(~traitement_type, scale = "free") +
  ggtitle("P90") +
  theme_bw() 
```


```{r}




table_sv[,c("GENERATION", "traitement_type", "TYPE.DE.MUTATION")] %>%
  ggplot(aes(x = traitement_type,
           by = TYPE.DE.MUTATION,
           fill = TYPE.DE.MUTATION)) +
  geom_bar(position=position_stack(), width=0.5, stat = "count")+
  scale_fill_brewer(palette="Dark2") +
  facet_wrap(~GENERATION, scale = "free") +
  labs(x = "Effectif des mutations", y = "traitement", fill = "Type de mutation\n(DEL = délétion\nINS = insertion)") +
  ggtitle("Distribution des types mutations (délétion et insertion)\nde variants structuraux par traitement et par génération") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1)) 


table_sv[which(table_sv$GENERATION == "P15"),c("traitement_type", "TYPE.DE.MUTATION", "LONGUEUR")] %>%
  ggplot(aes(y = abs(LONGUEUR),
           fill = TYPE.DE.MUTATION)) +
  geom_bar(width=0.5, stat = "count")+
  scale_fill_brewer(palette="Dark2") +
  #facet_wrap(~GENERATION, scale = "free") +
  labs(x = "traitement", y = "longueur absolue", fill = "Type de mutation\n(DEL = délétion\nINS = insertion)") +
  ggtitle("Distribution des types mutations (délétion et insertion)\nde variants structuraux par traitement et par génération") +
  facet_wrap(~TYPE.DE.MUTATION) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

```


```{r}
group_by(GENERATION, ECHANTILLON, TYPE.DE.MUTATION) %>%
  count()
  #pivot_wider(names_from = TYPE.DE.MUTATION)


names(df_mut_sv)[names(df_mut_sv) == "n"] <- "effectif_type_mutation"

df_mut_sv <- left_join(df_mut_sv, unique(table_sv[,c("GENERATION", "ECHANTILLON", "traitement_type")]), by = c("ECHANTILLON", "GENERATION")) 



df_mut_sv2 <- df_mut_sv %>% aggregate(effectif_type_mutation ~ GENERATION + ECHANTILLON, FUN = sum)
names(df_mut_sv2)[names(df_mut_sv2) == "effectif_type_mutation"] <- "effectif_mutation"
df_mut_sv <- left_join(df_mut_sv, df_mut_sv2, by = c("GENERATION", "ECHANTILLON"))
remove(df_mut_sv2)
df_mut_sv <- df_mut_sv %>% mutate(freq_mutation_type = effectif_type_mutation/effectif_mutation)
df_mut_sv$freq_mutation_type <- round(df_mut_sv$freq_mutation_type, 3)

#frequence allélique par type de mutation
table_sv %>% names()
df <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = mean)
df1 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = median)
df2 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = sd)
df3 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = max)
df4 <- table_sv %>% aggregate(FREQUENCE.ALL ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = min)

names(df)[names(df) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_mean"
names(df1)[names(df1) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_median"
names(df2)[names(df2) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_sd"
names(df3)[names(df3) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_max"
names(df4)[names(df4) == "FREQUENCE.ALL"] <- "FREQUENCE.ALL_min"

df <- left_join(df, df1, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df2, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df3, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df4, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df_mut_sv <- left_join(df_mut_sv, df, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))

remove(df, df1, df2, df3, df4)
#longueur du type de mutation par generation et échantillon
table_sv %>% names()
df <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = mean)
df1 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = median)
df2 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = sd)
df3 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = max)
df4 <- table_sv %>% aggregate(LONGUEUR ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = min)

names(df)[names(df) == "LONGUEUR"] <- "LONGUEUR_mean"
names(df1)[names(df1) == "LONGUEUR"] <- "LONGUEUR_median"
names(df2)[names(df2) == "LONGUEUR"] <- "LONGUEUR_sd"
names(df3)[names(df3) == "LONGUEUR"] <- "LONGUEUR_max"
names(df4)[names(df4) == "LONGUEUR"] <- "LONGUEUR_min"

df <- left_join(df, df1, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df2, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df3, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df <- left_join(df, df4, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
df_mut_sv <- left_join(df_mut_sv, df, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION"))
remove(df, df1, df2, df3, df4)

#nb de positions différentes concernées par generation par echantillon
table_sv$POSITION_factor <- as.factor(table_sv$POSITION)
nb_positions_gen_ech <- table_sv %>% aggregate(POSITION_factor ~ GENERATION + ECHANTILLON, FUN = function(x) length(unique(x)))
names(nb_positions_gen_ech)[names(nb_positions_gen_ech) == "POSITION_factor"] <- "nb_pos_gen_ech"
df_mut_sv <- left_join(df_mut_sv, nb_positions_gen_ech, by = c("GENERATION", "ECHANTILLON")) 
remove(nb_positions_gen_ech)

#nb de positions différentes concernées par generation par echantillon par type de mutation
nb_positions_gen_ech_type_mut <- table_sv %>% aggregate(POSITION_factor ~ GENERATION + ECHANTILLON + TYPE.DE.MUTATION, FUN = function(x) length(unique(x)))
names(nb_positions_gen_ech_type_mut)[names(nb_positions_gen_ech_type_mut) == "POSITION_factor"] <- "nb_pos_gen_ech_type_mut"
df_mut_sv <- left_join(df_mut_sv, nb_positions_gen_ech_type_mut, by = c("GENERATION", "ECHANTILLON", "TYPE.DE.MUTATION")) 
remove(nb_positions_gen_ech_type_mut)

df_mut_sv %>% names()
df_mut_sv <- df_mut_sv %>% relocate(traitement_type, .after = ECHANTILLON)
```



Regarder la distribution moyenne des mutations le long du génome par génération et par traitement
```{r}
table_genome_ann_CyHV3 <- read.csv("annotation_genes_CyHV3_genbank.csv", header = TRUE, sep = "\t")
table_genome_ann_CyHV3 %>% names()
table_genome_ann_CyHV3 <- mutate(table_genome_ann_CyHV3, gen_length = End-Begin)
table_genome_ann_CyHV3 <- table_genome_ann_CyHV3 %>% relocate (gen_length, .after = End)
table_genome_ann_CyHV3$gen_length %>% summary()
table_genome_ann_CyHV3$Gene.Type %>% unique() #protein-coding

#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#    267    1018    1969    2694    3205   30495 
```


```{r}
table_sv <- table_sv %>% mutate(mutation = 1)
df_P15_sv <- table_sv[which(table_sv$GENERATION == "P15"), ]

ggplot(df_P15_sv, aes(x = POSITION, fill = TYPE.DE.MUTATION)) +
  geom_histogram(binwidth = 100, position = "identity", alpha = 0.6) +
  scale_fill_brewer(palette="Dark2") +
  labs(title = "Distribution des mutations dans le génome par génération",
       x = "Position dans le génome",
       y = "Nombre de mutations",
       fill = "Type de mutation") +
  facet_wrap(~ECHANTILLON, scales = "free") +
  theme_minimal()

ggplot(df_P15_sv, aes(x = POSITION, fill = as.factor(TYPE.DE.MUTATION))) +
  geom_density(alpha = 0.5) +
  scale_fill_brewer(palette="Dark2") +
  labs(title = "Densité des mutations par position et génération",
       x = "Position dans le génome",
       y = "Densité",
       fill = "Génération") +
  facet_wrap(~ECHANTILLON, scales = "free") +
  theme_minimal()
```



















regarder les positions du génome les plus touchées par les mutations 
```{r}
table_sv <- table_sv[order(table_sv$POSITION),] 
#regarder le nombre de mutations par positions 

# Génome : 295100 pb
genome_ref <- c(1: 295100)
gen_ref <- as.data.frame(genome_ref)

names(gen_ref)[names(gen_ref) == "genome_ref"] <- "POSITION"
genome_ref_group <- seq(1, 295100 + 200, 200)
genome_ref_group %>% length() #numeric 1476
gen_ref$POSITION_group_index <- cut(gen_ref$POSITION, breaks = genome_ref_group, labels = FALSE, include.lowest = TRUE)
gen_ref$POSITION_group <- genome_ref_group[gen_ref$POSITION_group_index]
gen_ref[which(is.na(gen_ref$POSITION_group_index)== TRUE),]
gen_ref$POSITION_grp_interval <- paste0("(", genome_ref_group[gen_ref$POSITION_group_index], "-", 
                                  genome_ref_group[gen_ref$POSITION_group_index + 1], "]")


table_sv <- table_sv %>% mutate(mutation = 1)

table_sv_gen_ref <- left_join(gen_ref, table_sv, by = "POSITION")
table_sv_gen_ref[which(is.na(table_sv_gen_ref$mutation) == TRUE),"mutation"] <- 0

table_sv_gen_ref %>% names()




#table_distrib_mut_genome
df_P15_sv <- table_sv_gen_ref[which(table_sv_gen_ref$)] %>% aggregate(mutation ~ GENERATION + POSITION_group_index + POSITION_group + POSITION_grp_interval + ECHANTILLON + traitement_type, FUN = sum, na.rm = TRUE)


df1 <- df1[order(df1$POSITION_group_index),]
df2 <- table_sv_gen_ref %>% aggregate(mutation ~ POSITION_group_index + POSITION_group + POSITION_grp_interval, FUN = sum)
df2 <- df2[order(df2$POSITION_group_index),]
```


```{r}
#Rechercher le nombre de mutation moyen par génération par position
table_distrib_mut_genome <- table_sv_gen_ref %>% group_by(POSITION_group_index, POSITION_group, POSITION_grp_interval, GENERATION, ECHANTILLON, traitement_type) %>% count()
table_distrib_mut_genome$n %>% summary()


table_distrib_mut_genome %>% names()
df <- table_distrib_mut_genome %>% aggregate(n ~ GENERATION + POSITION_group_index + POSITION_group + POSITION_grp_interval, FUN =  mean)
df1 <- table_distrib_mut_genome %>% aggregate(n ~ GENERATION + POSITION_group_index + POSITION_group + POSITION_grp_interval, FUN =  median)
names(df)[names(df) == "n"] <- "mean_mutation"
names(df1)[names(df1) == "n"] <- "median_mutation"
df <- left_join(df, df1)
table_distrib_mut_genome <- left_join(table_distrib_mut_genome, df)
remove(df, df1)




table_sv$POSITION %>% class()
table_sv$POSITION %>% min() #1210
table_sv$POSITION %>% max() #284052
genome_ref_group[which(genome_ref_group >=min(table_sv$POSITION))] %>% min()#1401 #%>% length
genome_ref_group[which(genome_ref_group<=min(table_sv$POSITION))] %>% max()#1201
#1210 sera dans la catégorie 1201-1401
genome_ref_group[which(genome_ref_group>=max(table_sv$POSITION))] %>% min() #284101
genome_ref_group[which(genome_ref_group<=max(table_sv$POSITION))] %>% max() #284001


#284052
groupe <- seq(1201, 284101 +200, by = 200)
table_sv$POSITION_group_index <- cut(table_sv$POSITION, breaks = groupe, labels = FALSE, include.lowest = TRUE)
table_sv$POSITION_group <- groupe[table_sv$POSITION_group_index]
# Génération des étiquettes manuelles
table_sv$POSITION_grp_interval <- paste0("(", groupe[table_sv$POSITION_group_index], "-", 
                                  groupe[table_sv$POSITION_group_index + 1], "]")

table_sv[which(is.na(table_sv$POSITION_group_index)== TRUE),] %>% nrow() #0

table_sv %>% names()
table_distrib_mut_genome <- table_sv %>% group_by(POSITION_group_index, POSITION_group, POSITION_grp_interval, GENERATION, ECHANTILLON, traitement_type) %>% count()
table_distrib_mut_genome$n %>% summary()


######
table_distrib_mut_genome %>% names()
df <- table_distrib_mut_genome %>% aggregate(n ~ GENERATION + POSITION_group_index + POSITION_group + POSITION_grp_interval, FUN =  mean)
df1 <- table_distrib_mut_genome %>% aggregate(n ~ GENERATION + POSITION_group_index + POSITION_group + POSITION_grp_interval, FUN =  median)
names(df)[names(df) == "n"] <- "mean_mutation"
names(df1)[names(df1) == "n"] <- "median_mutation"
df <- left_join(df, df1)
table_distrib_mut_genome <- left_join(table_distrib_mut_genome, df)
remove(df, df1)


table_distrib_mut_genome %>% names()
gen_ref %>% names()

df <- left_join(gen_ref, table_distrib_mut_genome, by = c(POSITION))
##############
table_sv$POSITION_group %>% class()
table_sv$POSITION_group <- as.numeric(table_sv$POSITION_group)

#table_sv$POSITION_group <- format(table_sv$POSITION_group, scientific=F)
which(names(table_sv) == "POSITION_group")
table_sv <- table_sv[,-c(11,12,13)]
ggplot(table_sv, aes(x = POSITION_group))



table_sv %>% names()
table_sv$POSITION %>% summary()


table_sv[,c("POSITION", "POSITION_FACTOR", "")]
df_mut_sv2 <- left_join()

gq_data$GenotypeQuality_group <- cut(gq_data$GQ,
                                  breaks = seq(1, 47, by = 1),   # Définir les breaks comme souhaité
                                  labels = c( "1-2",  "2-3",  "3-4",  "4-5",  "5-6",  "6-7",  "7-8",  "8-9",  "9-10", "10-11", "11-12", "12-13", "13-14", "14-15", "15-16", "16-17", "17-18", "18-19", "19-20", "20-21", "21-22", "22-23", "23-24", "24-25", "25-26", "26-27", "27-28", "28-29", "29-30", "30-31", "31-32", "32-33", "33-34", "34-35", "35-36", "36-37", "37-38", "38-39", "39-40", "40-41", "41-42", "42-43", "43-44", "44-45", "45-46", "46-47"), right = FALSE)
```


